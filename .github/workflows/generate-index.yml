name: Generate Deck Index

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  generate-index:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install jq
      run: sudo apt-get install -y jq
      
    - name: Generate index.json
      run: |
        # Start the JSON structure
        echo '{ "last_updated": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'", "semesters": [] }' > index.json
        
        # Loop through all directories (except hidden ones)
        for dir in */; do
          # Skip hidden folders and .github
          if [[ "$dir" == .*/ || "$dir" == ".github/" ]]; then
            continue
          fi
          
          dirname=$(basename "$dir")
          echo "ðŸ“ Processing folder: $dirname"
          
          # Check for meta.json for custom display name
          display_name="$dirname"
          if [ -f "${dir}meta.json" ]; then
            custom_name=$(jq -r '.display_name // empty' "${dir}meta.json" 2>/dev/null)
            if [ -n "$custom_name" ]; then
              display_name="$custom_name"
            fi
          fi
          
          # Find all .apkg and .json deck files (not meta.json)
          files_json="[]"
          
          for file in "$dir"*.apkg "$dir"*.json; do
            # Skip if no matches or if it's meta.json
            [ -e "$file" ] || continue
            [[ "$file" == *"meta.json" ]] && continue
            
            filename=$(basename "$file")
            filepath="$file"
            
            # Get file size in MB
            size_bytes=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            size_mb=$(echo "scale=2; $size_bytes / 1048576" | bc)
            
            # Extract name without extension
            name="${filename%.*}"
            # Convert underscores and hyphens to spaces, capitalize
            pretty_name=$(echo "$name" | sed 's/[_-]/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')
            
            # Add to files array
            files_json=$(echo "$files_json" | jq \
              --arg path "$filepath" \
              --arg name "$pretty_name" \
              --arg size "$size_mb" \
              '. += [{"path": $path, "name": $name, "size_mb": ($size | tonumber)}]')
            
            echo "  ðŸ“„ Found: $filename ($size_mb MB)"
          done
          
          # Only add semester if it has files
          file_count=$(echo "$files_json" | jq '. | length')
          if [ "$file_count" -gt 0 ]; then
            # Add this semester to the index
            tmp=$(mktemp)
            jq --arg name "$dirname" \
               --arg display "$display_name" \
               --argjson files "$files_json" \
               '.semesters += [{"name": $name, "display_name": $display, "files": $files}]' \
               index.json > "$tmp" && mv "$tmp" index.json
            
            echo "  âœ… Added $file_count files from $dirname"
          fi
        done
        
        echo ""
        echo "ðŸ“‹ Generated index.json:"
        cat index.json | jq .
        
    - name: Commit and push if changed
      run: |
        git config --local user.name 'OpenAnki Bot'
        git config --local user.email 'bot@openanki.app'
        git add index.json
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "No changes to index.json"
        else
          git commit -m "ðŸ”„ Auto-update deck index"
          git push
        fi
